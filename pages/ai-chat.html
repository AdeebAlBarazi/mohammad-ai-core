<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø®ØµÙŠ</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b1220; color:#e8edf7; margin:0; }
    header { padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; gap:12px; }
    .status { font-size:12px; opacity:.8; }
    .typing { font-size:12px; opacity:.9; display:none; align-items:center; gap:6px; }
    .typing.on { display:inline-flex; }
    .typing .dots { display:inline-block; width:16px; text-align:left; }
    .typing .d { animation: blink 1.2s infinite ease-in-out; opacity:.2; }
    .typing .d:nth-child(2){ animation-delay:.2s; }
    .typing .d:nth-child(3){ animation-delay:.4s; }
    @keyframes blink { 0%{opacity:.2} 20%{opacity:1} 100%{opacity:.2} }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .msgs { display:flex; flex-direction:column; gap:10px; padding-bottom: 80px; }
    .msg { padding:10px 12px; border-radius:10px; max-width: 80%; line-height:1.5; }
    .user { background: rgba(80,120,255,.15); align-self:flex-end; border:1px solid rgba(80,120,255,.35); }
    .ai { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); position:relative; }
    .msg-actions { position:absolute; inset-inline-end:8px; inset-block-start:8px; display:flex; gap:6px; opacity:.8; }
    .msg-actions button { font-size:11px; padding:4px 8px; border-radius:8px; }
    .composer { position:fixed; bottom:0; left:0; right:0; background:#0b1220; border-top:1px solid rgba(255,255,255,.08); padding:10px 16px; display:flex; gap:8px; }
    textarea { flex:1; resize:vertical; min-height:44px; max-height:160px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0f172a; color:#e8edf7; }
    button { padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.22); background:#17203a; color:#fff; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .ai pre { background:#0f172a; padding:10px; border-radius:8px; overflow:auto; }
    .ai code { background:#0f172a; padding:2px 4px; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <div>ğŸ¤ Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø­Ù…Ø¯</div>
    <div class="status" id="aiStatus">ÙŠØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…â€¦</div>
    <span class="typing" id="typing" aria-live="polite">ÙŠÙƒØªØ¨ <span class="dots"><span class="d">â€¢</span><span class="d">â€¢</span><span class="d">â€¢</span></span></span>
    <div style="margin-inline-start:auto; display:flex; align-items:center; gap:6px; font-size:12px; opacity:.9;">
      <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
        <input type="checkbox" id="streamToggle" checked />
        <span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</span>
      </label>
      <button id="stopStream" style="display:none; font-size:12px; padding:6px 10px;">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
      <button id="sessionsBtn" style="font-size:12px; padding:6px 10px;">Ø¬Ù„Ø³Ø§ØªÙŠ</button>
    </div>
  </header>
  <div class="wrap">
    <div class="msgs" id="msgs"></div>
    <div id="sessionsPanel" style="display:none; margin-top:12px; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</strong>
        <span id="sessionsStatus" style="font-size:12px; opacity:.8;"></span>
        <div style="margin-inline-start:auto; display:flex; gap:6px; align-items:center;">
          <input id="newSessionInput" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯" style="padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#0f172a; color:#e8edf7;"/>
          <button id="useSessionBtn">Ø§Ø³ØªØ®Ø¯Ù…</button>
        </div>
      </div>
      <div id="sessionsList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
      <div id="sessionHistory" style="margin-top:10px; display:none;">
        <div style="display:flex; align-items:center; gap:8px;">
          <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©</strong>
          <button id="hideHistBtn" style="font-size:11px; margin-inline-start:auto;">Ø¥Ø®ÙØ§Ø¡</button>
        </div>
        <div id="sessionHistoryList" style="margin-top:6px; display:flex; flex-direction:column; gap:6px;"></div>
      </div>
    </div>
  </div>
  <div class="composer">
    <textarea id="prompt" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒâ€¦"></textarea>
    <button id="send">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <script src="../js/dev-api-detect.js"></script>
  <script src="../js/market-common.js"></script>
  <script>
    (function(){
      const msgs = document.getElementById('msgs');
      const promptEl = document.getElementById('prompt');
      const sendBtn = document.getElementById('send');
      const statusEl = document.getElementById('aiStatus');
      const streamToggle = document.getElementById('streamToggle');
      const typingEl = document.getElementById('typing');
      const history = [];
      let sessionId = 'web-'+Math.random().toString(36).slice(2,9);
      let streamAbort = null;
      const sessionsBtn = document.getElementById('sessionsBtn');
      const sessionsPanel = document.getElementById('sessionsPanel');
      const sessionsList = document.getElementById('sessionsList');
      const sessionsStatus = document.getElementById('sessionsStatus');
      const newSessionInput = document.getElementById('newSessionInput');
      const useSessionBtn = document.getElementById('useSessionBtn');
      const sessionHistory = document.getElementById('sessionHistory');
      const sessionHistoryList = document.getElementById('sessionHistoryList');
      const hideHistBtn = document.getElementById('hideHistBtn');

      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
      function mdToHtml(md){
        let s = String(md||'');
        s = s.replace(/\r/g,'');
        // code blocks ```
        s = s.replace(/```([\s\S]*?)```/g, (m, p1) => '<pre><code>'+escapeHtml(p1)+'</code></pre>');
        // inline code
        s = s.replace(/`([^`]+)`/g, (m,p1)=> '<code>'+escapeHtml(p1)+'</code>');
        // bold/italic
        s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        s = s.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        // links [text](url)
        s = s.replace(/\[([^\]]+)\]\((https?:[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        // lists
        const lines = s.split('\n');
        let html = ''; let ul = false;
        for(const ln of lines){
          if(/^\s*[-*]\s+/.test(ln)){ if(!ul){ html += '<ul>'; ul = true; } html += '<li>'+ln.replace(/^\s*[-*]\s+/,'')+'</li>'; }
          else { if(ul){ html += '</ul>'; ul=false; } html += ln ? '<p>'+ln+'</p>' : '<br/>'; }
        }
        if(ul) html += '</ul>';
        return html;
      }

      function add(role, text){
        const d = document.createElement('div'); d.className = 'msg ' + (role==='user'?'user':'ai');
        if(role==='assistant' || role==='ai'){
          d.innerHTML = mdToHtml(text);
          const act = document.createElement('div'); act.className='msg-actions';
          const copyBtn = document.createElement('button'); copyBtn.textContent='Ù†Ø³Ø®';
          copyBtn.addEventListener('click', async ()=>{ try { await navigator.clipboard.writeText(String(text)); copyBtn.textContent='ØªÙ…'; setTimeout(()=>copyBtn.textContent='Ù†Ø³Ø®', 1500); } catch(_){ copyBtn.textContent='Ø®Ø·Ø£'; setTimeout(()=>copyBtn.textContent='Ù†Ø³Ø®', 1500); } });
          act.appendChild(copyBtn);
          d.appendChild(act);
        } else {
          d.textContent = text;
        }
        msgs.appendChild(d); d.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }

      async function getBase(){
        try {
          if (window.Market && Market.Common && typeof Market.Common.whenReady==='function') { await Market.Common.whenReady(); }
          const base = (Market && Market.Common && Market.Common.getApiBase && Market.Common.getApiBase()) || (Market && Market.Common && Market.Common.apiBase) || '';
          if (!base) return '';
          // If base already has /api strip trailing /api to avoid duplication
          return base.replace(/\/?api\/?$/i,'');
        } catch(_) { return ''; }
      }

      function setTyping(on){ if(typingEl){ typingEl.classList.toggle('on', !!on); } }
      function setStopVisible(on){ const b=document.getElementById('stopStream'); if(b){ b.style.display = on ? 'inline-block' : 'none'; } }

      async function refreshSessions(){
        try {
          sessionsStatus.textContent = '...';
          const base = await getBase();
          const url = (base || '') + '/api/ai/sessions';
          const r = await fetch(url, { method:'GET' });
          const j = await r.json();
          if(!r.ok || !j.ok){ throw new Error(j && j.error || 'failed'); }
          sessionsList.innerHTML = '';
          const items = Array.isArray(j.items) ? j.items : [];
          items.sort((a,b)=> String(b.lastTs||'').localeCompare(String(a.lastTs||'')) );
          for(const it of items){
            const chip = document.createElement('div');
            chip.style.cssText = 'display:flex; gap:6px; align-items:center; padding:6px 8px; border:1px solid rgba(255,255,255,.15); border-radius:999px; background:#0f172a;';
            const label = document.createElement('span'); label.textContent = it.id + (it.id===sessionId ? ' (Ù†Ø´Ø·)' : ''); label.style.fontSize='12px';
            const useBtn = document.createElement('button'); useBtn.textContent='ØªÙØ¹ÙŠÙ„'; useBtn.style.fontSize='11px'; useBtn.addEventListener('click', ()=>{ sessionId = it.id; sessionsStatus.textContent='ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„: '+it.id; });
            const viewBtn = document.createElement('button'); viewBtn.textContent='Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®'; viewBtn.style.fontSize='11px'; viewBtn.addEventListener('click', async ()=>{
              try {
                const base2 = await getBase();
                const urlHist = (base2||'') + '/api/ai/sessions/' + encodeURIComponent(it.id) + '?limit=10';
                const rr = await fetch(urlHist, { method:'GET' }); const jj = await rr.json(); if(!rr.ok || !jj.ok) throw new Error(jj && jj.error || 'hist_failed');
                sessionHistoryList.innerHTML='';
                const arr = Array.isArray(jj.items)? jj.items : [];
                for(const h of arr){ const row = document.createElement('div'); row.style.cssText='display:flex; gap:8px; align-items:flex-start;'; const badge = document.createElement('span'); badge.textContent = h.mode || 'mode'; badge.style.cssText='font-size:11px; opacity:.8; border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:2px 6px;'; const txt = document.createElement('div'); txt.style.cssText='font-size:13px;'; txt.textContent = (h.in? ('Ø³: '+h.in):'') + (h.out? (' \nØ¬: '+h.out):''); row.appendChild(badge); row.appendChild(txt); sessionHistoryList.appendChild(row); }
                sessionHistory.style.display='block';
              } catch(e){ sessionsStatus.textContent = 'ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®'; }
            });
            const exportBtn = document.createElement('button'); exportBtn.textContent='ØªØµØ¯ÙŠØ±'; exportBtn.style.fontSize='11px'; exportBtn.addEventListener('click', async ()=>{
              try {
                const base2 = await getBase();
                // Simple filter prompt: since hours presets
                const presets = [ {label:'Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©', val:24}, {label:'Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…', val:24*7}, {label:'Ø§Ù„ÙƒÙ„', val:0} ];
                let selected = 0; try { selected = await (async()=>{ return 0; })(); } catch(_){ }
                // Default to 24h
                const h = 24;
                const urlExp = (base2||'') + '/api/ai/sessions/' + encodeURIComponent(it.id) + '/export' + (h>0 ? ('?sinceHours='+h) : '');
                const rr = await fetch(urlExp, { method:'GET' }); const blob = await rr.blob();
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `session-${it.id}.json`; document.body.appendChild(link); link.click(); setTimeout(()=>{ URL.revokeObjectURL(link.href); link.remove(); }, 0);
              } catch(e){ sessionsStatus.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±'; }
            });
            const delBtn = document.createElement('button'); delBtn.textContent='Ø­Ø°Ù'; delBtn.style.fontSize='11px'; delBtn.addEventListener('click', async ()=>{
              try {
                const urlDel = (base||'') + '/api/ai/sessions/' + encodeURIComponent(it.id);
                const rr = await fetch(urlDel, { method:'DELETE' }); const jj = await rr.json(); if(!rr.ok || !jj.ok) throw new Error(jj && jj.error || 'delete_failed');
                if(sessionId===it.id){ sessionId = 'web-'+Math.random().toString(36).slice(2,9); }
                await refreshSessions();
              } catch(e){ sessionsStatus.textContent = 'Ø®Ø·Ø£ Ø­Ø°Ù'; }
            });
            chip.appendChild(label); chip.appendChild(useBtn); chip.appendChild(viewBtn); chip.appendChild(exportBtn); chip.appendChild(delBtn);
            sessionsList.appendChild(chip);
          }
          sessionsStatus.textContent = `Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${sessionId}`;
        } catch(e){ sessionsStatus.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª'; }
      }

      async function send(){
        const txt = (promptEl.value || '').trim();
        if(!txt) return; sendBtn.disabled = true; promptEl.value = '';
        add('user', txt); history.push({ role:'user', content: txt });
        const base = await getBase();
        const useStream = !!streamToggle.checked;
        const url = (base || '') + (useStream ? '/api/ai/chat/stream' : '/api/ai/chat');
        const t0 = performance.now();
        try {
          setTyping(true);
          if(useStream){
            streamAbort = new AbortController(); setStopVisible(true);
            const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'text/event-stream' }, body: JSON.stringify({ prompt: txt, history: history.slice(-8), sessionId }), signal: streamAbort.signal });
            if(!r.ok){ throw new Error('request_failed'); }
            const reader = r.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buf=''; let current='';
            const live = document.createElement('div'); live.className='msg ai'; live.innerHTML='';
            const act = document.createElement('div'); act.className='msg-actions';
            const copyBtn = document.createElement('button'); copyBtn.textContent='Ù†Ø³Ø®'; copyBtn.disabled=true;
            copyBtn.addEventListener('click', async ()=>{ try { await navigator.clipboard.writeText(String(current)); copyBtn.textContent='ØªÙ…'; setTimeout(()=>copyBtn.textContent='Ù†Ø³Ø®', 1500); } catch(_){ copyBtn.textContent='Ø®Ø·Ø£'; setTimeout(()=>copyBtn.textContent='Ù†Ø³Ø®', 1500); } });
            act.appendChild(copyBtn); live.appendChild(act);
            msgs.appendChild(live); live.scrollIntoView({ behavior:'smooth', block:'end' });
            for(;;){
              const { value, done } = await reader.read();
              if(done) break;
              buf += decoder.decode(value, { stream:true });
              let idx;
              while((idx = buf.indexOf('\n\n')) !== -1){
                const chunk = buf.slice(0, idx).trim();
                buf = buf.slice(idx+2);
                if(!chunk) continue;
                const lines = chunk.split('\n');
                for(const line of lines){
                  if(line.startsWith('data: ')){
                    const data = line.slice(6);
                    if(data === '[DONE]') { break; }
                    try {
                      const j = JSON.parse(data);
                      if(j && typeof j.delta === 'string'){ current += j.delta; live.innerHTML = mdToHtml(current); }
                      if(j && j.ok){ const latency = Math.round(performance.now()-t0); statusEl.textContent = `Ù…ØªØµÙ„ â€¢ ${latency}ms`; }
                    } catch(_){ }
                  }
                }
              }
            }
            copyBtn.disabled = false; setStopVisible(false);
            history.push({ role:'assistant', content: current });
          } else {
            const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ prompt: txt, history: history.slice(-8), sessionId }) });
            const j = await r.json();
            if(!r.ok || !j.ok){ throw new Error(j && j.error || 'request_failed'); }
            const latency = Math.round(performance.now()-t0);
            statusEl.textContent = `Ù…ØªØµÙ„ â€¢ ${latency}ms`;
            add('assistant', j.reply || ''); history.push({ role:'assistant', content: j.reply || '' });
          }
        } catch(e){ statusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯'; add('assistant', 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (e && e.message || e)); }
        finally { setTyping(false); sendBtn.disabled = false; setStopVisible(false); streamAbort = null; }
      }
        sessionsBtn.addEventListener('click', async ()=>{
          const on = sessionsPanel.style.display !== 'none' ? false : true;
          sessionsPanel.style.display = on ? 'block' : 'none';
          if(on){ await refreshSessions(); }
        });
        useSessionBtn.addEventListener('click', async ()=>{
          const id = (newSessionInput.value||'').trim(); if(!id) return;
          sessionId = id; sessionsStatus.textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: '+id; newSessionInput.value='';
          await refreshSessions();
        });
        hideHistBtn.addEventListener('click', ()=>{ sessionHistory.style.display='none'; });
  document.getElementById('stopStream').addEventListener('click', ()=>{ try { if(streamAbort){ streamAbort.abort(); } setStopVisible(false); } catch(_){} });

      sendBtn.addEventListener('click', send);
      promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

      (async function init(){
        try {
          const base = await getBase();
          if(base){ statusEl.textContent = 'Ø¬Ø§Ù‡Ø²'; } else { statusEl.textContent = 'Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ API Base'; }
          // Preload sessions quietly
          setTimeout(()=>{ refreshSessions(); }, 300);
        } catch(_){ statusEl.textContent = '...'; }
      })();
    })();
  </script>
</body>
</html>
