# ๐ ุฏููู ุงููุนูุงุฑูุฉ ุงููุงููุฉ ูููููู ุงูุฐูู ุงููุญููู (ูุณุชุดุงุฑ ูุญูุฏ)

AI Portable Agent โ Architecture Guide

ุงูุฅุตุฏุงุฑ: 2025-12-01

---

## ุงููุญุชููุงุช

1. [ููุฏูุฉ](#ููุฏูุฉ)
2. [ุงูุฑุญูุฉ ูู ุงูุณุคุงู ุฅูู ุงูุฅุฌุงุจุฉ](#ุงูุฑุญูุฉ-ูู-ุงูุณุคุงู-ุฅูู-ุงูุฅุฌุงุจุฉ)
3. [ุงููููููุงุช ุงูุฃุณุงุณูุฉ ูููุธุงู](#ุงููููููุงุช-ุงูุฃุณุงุณูุฉ-ูููุธุงู)
4. [ูููู ุงููููุงุช ูุงููุฌูุฏุงุช](#ูููู-ุงููููุงุช-ูุงููุฌูุฏุงุช)
5. [ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุจุงูุชูุตูู](#ุฏูุฑุฉ-ุญูุงุฉ-ุงูุทูุจ-ุจุงูุชูุตูู)
6. [ูุตุงุฏุฑ ุงูุฅุฌุงุจุงุช](#ูุตุงุฏุฑ-ุงูุฅุฌุงุจุงุช)
7. [ุทุจูุฉ ุงูุฐุงูุฑุฉ](#ุทุจูุฉ-ุงูุฐุงูุฑุฉ)
8. [ุงุฎุชูุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช](#ุงุฎุชูุงุฑ-ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
9. [ูููููุฉ ุงููุนูุงุฑูุฉ (Mermaid)](#ูููููุฉ-ุงููุนูุงุฑูุฉ)
10. [ุฎุทูุงุช ุงูุจูุงุก ูู ุงูุตูุฑ ุญุชู ุงูุชุดุบูู](#ุฎุทูุงุช-ุงูุจูุงุก-ูู-ุงูุตูุฑ-ุญุชู-ุงูุชุดุบูู)
11. [ุทุจูุฉ ุงูุฃุฏูุงุช (Tools โ Market Integration)](#ุทุจูุฉ-ุงูุฃุฏูุงุช-tools--market-integration)
12. [ุงููุฑุงูุจุฉ ูSSE ูุงููุดุฑ](#ุงููุฑุงูุจุฉ-ูsse-ูุงููุดุฑ)
13. [ููุฎุต ููุงุฆู](#ููุฎุต-ููุงุฆู)

---

## ููุฏูุฉ

ุงููููู ุงูุฐูู "ูุณุชุดุงุฑ ูุญูุฏ" ูู ูุธุงู ุฐูุงุก ุตูุงุนู ูุญููู ููุงุจู ููููู ูุนูู ุนุจุฑ ุงููุชุตูุญ ูุงูุณูุฑูุฑ ูCLI ูVS Code.
ุงููุนูุงุฑููุฉ ูุธููุฉ ูููุณููุฉ: ูุงุฌูุฉ ุฎูููุฉุ ุทุจูุฉ APIุ ููุงุฉ ุฐูุงุก ูุณุชููุฉ (agent-core)ุ ุฐุงูุฑุฉ ุฌูุณุงุช ูุญูููุฉุ ููุฒููุฏ ูููุฐุฌ ูุงุจู ููุงุณุชุจุฏุงู.

ููุฏู ูุฐุง ุงูุฏููู ุฅูู ุชูุซูู ุงูุฑุญูุฉ ุงููุงููุฉ ูู ุชููู ุงูุณุคุงู ูุญุชู ุฅูุชุงุฌ ุงูุฅุฌุงุจุฉุ ูุน ูุตู ุงูุทุจูุงุช ูุงููููุงุช ููุณุงุฑุงุช ุงููุดุฑ.

---

## ุงูุฑุญูุฉ ูู ุงูุณุคุงู ุฅูู ุงูุฅุฌุงุจุฉ

1) ุงููุณุชุฎุฏู ููุชุจ ุฑุณุงูุฉ ุฏุงุฎู ุตูุญุฉ `pages/ai-chat.html`.
2) ุงููุงุฌูุฉ ุชุฑุณู ุงูุทูุจ ุฅูู ุงูุณูุฑูุฑ ุนุจุฑ `POST /api/ai/chat` ุฃู `POST /api/ai/chat/stream` (SSE).
3) ุฑุงูุชุฑ `src/routes/ai.js` ููุฑูุฑ ุงูุฑุณุงูุฉ ุฅูู ููุงุฉ ุงูุฐูุงุก `agent-core`.
4) ุงูููุงุฉ ุชููู ุจู:
   - ุชุญููู ุงููููุฉ ูู `agent-core/profile.json`.
   - ุงุณุชุนุงุฏุฉ ุชุงุฑูุฎ ุงูุฌูุณุฉ ูู ุงูุฐุงูุฑุฉ.
   - ุงุฎุชูุงุฑ ูุฒูุฏ ุงููููุฐุฌ (OpenAI ุฃู Stub).
   - ุฅุฑุณุงู ุงูุทูุจ ููููุฏูู ูุฌูุน ุงููุฎุฑุฌุงุช ุจุดูู ูุจุงุดุฑ ุฃู ูุชุฏูู.
5) ูุชู ุญูุธ ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ ูู ุงูุฐุงูุฑุฉ ูุฅุฑุฌุงุน ุงูุฅุฌุงุจุฉ.
6) ุงููุงุฌูุฉ ุชุนุฑุถ ุงูุฑุณุงูุฉ ุจุดูู Markdown ูุน ุฅููุงูููุฉ ุงููุณุฎ ูุฅููุงู ุงูุจุซ.

---

## ุงููููููุงุช ุงูุฃุณุงุณูุฉ ูููุธุงู

### 1) ูุงุฌูุฉ ุงููุณุชุฎุฏู (UI)

| ุงููุณุงุฑ | ุงููุตู |
|---|---|
| `pages/ai-chat.html` | ูุงุฌูุฉ ุงูุฏุฑุฏุดุฉ ูุน ุฏุนู ุงูุจุซุ ุงูุฌูุณุงุชุ ุงููุณุฎุ ูุถุจุท API Base ูุฏูููุง. |
| `pages/ai-chat-healthz.html` | ุตูุญุฉ ุตุญุฉ ููุญุต Ping ูSSE ูู ุงููุชุตูุญ. |

ูุธุงุฆู ุฑุฆูุณูุฉ:
- ุฅุฑุณุงู ุงูุทูุจุงุช ุฅูู `/api/ai/chat` ู`/api/ai/chat/stream`.
- ุนุฑุถ ุงูุฑุณุงุฆู ูุน Markdownุ ุฒุฑ ูุณุฎุ ูุฅููุงู ุงูุจุซ.
- ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช (ุฅูุดุงุก/ุชูุนูู/ุญุฐู/ุชุตุฏูุฑ). 

### 2) ุทุจูุฉ ุงูุณูุฑูุฑ (Server/API)

| ุงููุณุงุฑ | ุงููุตู |
|---|---|
| `server.js` | ููุทุฉ ุชุดุบูู Expressุ ููุฏู `/pages` ุซุงุจุชุฉ ูููุญูุฏ ุงูุฃุตู ููุซุจุช CORS. |
| `src/routes/ai.js` | ุฑุงูุชุฑ `/api/ai/*` (chat JSON, chat/stream SSE, sessions, tools/call). |

ูุธุงุฆู ุฑุฆูุณูุฉ:
- ุชูุฑูุฑ ุงูุทูุจุงุช ุฅูู `agent-core`.
- ุชุฑููุณุงุช SSE ุตูุจุฉ: `no-cache, no-transform` ู`X-Accel-Buffering: no`.
- ููุงููุณ (Prometheus) ูุชุณุฌูู ุชุฏููู (Audit).

### 3) ููุงุฉ ุงูุฐูุงุก (agent-core)

| ุงูููู/ุงููุฌูุฏ | ุงููุตู |
|---|---|
| `agent-core/index.js` | ุงูุฏูุงู `chat()` ู`stream()` + ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ูุงูุฌูุณุงุช. |
| `agent-core/profile.json` | ูููุฉ ุงููุณุงุนุฏ ูุงูุณูุงุณุงุช ูุงูููุฏุงุช. |
| `agent-core/memory/sessions/*.jsonl` | ุชุงุฑูุฎ ุงูุฌูุณุงุช ุจุตูุบุฉ JSONL. |
| `agent-core/tools/` | ุทุจูุฉ ุงูุฃุฏูุงุช (echo, math ูุฃุฏูุงุช ุงูุณูู ูุงุญููุง). |

### 4) ูุฒูุฏ ุงููููุฐุฌ

| ุงููุฒูุฏ | ูุชู ููุณุชุฎุฏู | ุงููุตู |
|---|---|---|
| Stub | ุบูุงุจ `OPENAI_API_KEY` | ุฑุฏูุฏ ุชุฌุฑูุจูุฉ ุจุฏูู ุชูููุฉ. |
| OpenAI | ูุฌูุฏ ุงูููุชุงุญ | ุฑุฏูุฏ ูุนููุฉ ูู GPT ููู ุงูููุฏูู ุงููุญุฏุฏ. |

---

## ูููู ุงููููุงุช ูุงููุฌูุฏุงุช

```text
systems/marketplace/
  server.js
  src/
    routes/
      ai.js
  pages/
    ai-chat.html
    ai-chat-healthz.html
  agent-core/
    index.js
    profile.json
    memory/
      sessions/
        <session>.jsonl
    tools/
      index.js
```

> ููุงุญุธุฉ: ูุฏ ุชุฎุชูู ุงูุชูุงุตูู ูููููุง ุญุณุจ ุชุทููุฑ ุงููุณุชูุฏุนุ ููู ุงูุชุฑุชูุจ ุงูููุทูู ููุง ุฃุนูุงู.

---

## ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุจุงูุชูุตูู

### 1) ูู ุงููุงุฌูุฉ

```javascript
fetch('/api/ai/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ prompt: userText, sessionId: 'mohammad-main', mode: 'personal' })
});
```

### 2) ูู ุฑุงูุชุฑ `/api/ai/chat`

```javascript
const core = require('../../agent-core');
const result = await core.chat({ prompt, sessionId, mode, history });
res.json({ ok: true, reply: result.reply, model: result.model });
```

### 3) ูู `agent-core/chat()`

- ุชุญููู `profile.json`.
- ุฌูุจ ุงูุชุงุฑูุฎ (memory Store).
- ุงุฎุชูุงุฑ ุงููุฒูุฏ (OpenAI/Stub) ููู ุงูุจูุฆุฉ.
- ุฅุฑุณุงู ุงูุฑุณุงุฆู ููููุฏูู.
- ุญูุธ ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ ูู ุฐุงูุฑุฉ ุงูุฌูุณุฉ.
- ุฅุฑุฌุงุน ุงููุชูุฌุฉ ูุน `usage` ู`latency` ุฅู ุชููุฑุช.

---

## ูุตุงุฏุฑ ุงูุฅุฌุงุจุงุช

1) ุงููุฒูุฏ (OpenAI ุฃู Stub): ุงููุตุฏุฑ ุงูุฃุณุงุณู ุงูุญุงูู.
2) ููู ุงูุดุฎุตูุฉ `profile.json`: ูุถุจุท ุงููุจุฑุฉ ูุงูุณูุงุณุงุช.
3) ุงูุฐุงูุฑุฉ (history): ุณูุงู ูู ุงูุฌูุณุฉ ุงููุงุถูุฉ.
4) ูุณุชูุจููุง: ุทุจูุฉ RAG ููุฏู ุงูุฅุฌุงุจุงุช ุจููุงุทุน ูู ูุซุงุฆู ุงููุฌุงู.

---

## ุทุจูุฉ ุงูุฐุงูุฑุฉ

- ุงููุณุงุฑ: `agent-core/memory/sessions/`.
- ุงูุตูุบุฉ: JSONL (ุณุทุฑ ููู ุฑุณุงูุฉ).

ูุซุงู:
```json
{"role":"user","content":"ูุฑุญุจุง"}
{"role":"assistant","content":"ุฃููุง ูุญูุฏ"}
```

ููุฒุงุช:
- ูุญูููุฉ ููุงุจูุฉ ููุฃุฑุดูุฉ.
- ูุงุจูุฉ ููุงุณุชุจุฏุงู ุจุจุงููุฏ SQLite/pg ูุงุญููุง.

---

## ุงุฎุชูุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช

| ุงููุฑุญูุฉ | ุงูุชุฎุฒูู | ุงูุงุณุชุฎุฏุงู |
|---|---|---|
| 1 | JSONL | ุชุทููุฑ ูุชุฌุฑูุจ ุณุฑูุน |
| 2 | SQLite | ูููู ูุญููู ููู ููุจุณูุท |
| 3 | PostgreSQL/pgvector | ุฅูุชุงุฌ ูุน RAG ูุชุนุฏุฏ ุฎุฏูุงุช |

---

## ูููููุฉ ุงููุนูุงุฑูุฉ

ูููู ุชุถููู ูุฐุง ุงููุฎุทุท (Mermaid) ูุจุงุดุฑุฉ ุฏุงุฎู ูุฐุง ุงูููู ููุนุฑุถ ุฑุณูุงู ุจูุงููุงู ูู ููุตุงุช ุชุฏุนู Mermaid:

```mermaid
flowchart TD

    %% ุงูุทุจูุฉ ุงูุฃูุงููุฉ
    subgraph Client["Client Layer"]
        BROWSER["๐งโ๐ป Browser<br/>ai-chat.html"]
    end

    %% Nginx / Ingress
    subgraph Edge["Edge / Gateway"]
        NGINX["๐ Nginx / Ingress<br/>TLS, CSP, Routing<br/>FORCE_HTTPS, HSTS"]
    end

    %% ุทุจูุฉ ุงูู API
    subgraph API["API Layer (Node/Express)"]
        API_AI["/api/ai/*<br/>AI Routes"]
        API_MARKET["/api/market/*<br/>Market Routes"]
    end

    %% ููุงุฉ ุงูุฐูุงุก
    subgraph CORE["AI Core (agent-core)"]
        AGENT["agent-core/index.js<br/>chat(), tools(), memory()"]
        PROFILE["profile.json<br/>Personality & Modes"]
        MEMORY["memory/*<br/>Sessions, History"]
        TOOLS["tools/*<br/>Market, Files, System Tools"]
    end

    %% RAG
    subgraph RAG["RAG & Knowledge Layer"]
        VDB["RAG Vector DB<br/>(SQLite / Supabase / pgvector)"]
        DOCS["Domain Docs<br/>(ุณููุ ุนููุฏุ ูุดุงุฑูุน)"]
    end

    %% Model Provider
    subgraph MODEL["Model Provider Layer"]
        OPENAI["OpenAI API<br/>GPT-4.1-mini / ..."]
        STUB["Local Stub<br/>No-cost Model"]
    end

    %% Market Systems
    subgraph MARKET["Core Systems / Market"]
        MSYS["Market System<br/>Orders, Products, Sellers"]
        OTHER["Other Systems<br/>Inspection, Club, ..."]
    end

    %% Observability
    subgraph OBS["Observability"]
        LOGS["Logs<br/>Request/Response, Errors"]
        METRICS["Metrics & Monitoring<br/>Dashboards, Alerts"]
    end

    %% CI/CD
    subgraph CICD["CI / CD Pipeline"]
        GIT["GitHub Repo<br/>mohammad-ai-core / marketplace"]
        CI["CI Jobs<br/>Lint, Test, Build"]
        CD["CD Deploy<br/>VPS / Docker / K8s"]
    end

    %% ุงููุณุชูุจู
    subgraph FUTURE["Future Enhancements"]
        SSE["SSE Streaming<br/>/api/ai/chat/stream"]
        MCP["MCP Tools<br/>Shared Tool Protocol"]
    end

    %% Connections
    BROWSER -->|"HTTPS / fetch"| NGINX
    NGINX -->|"Proxy /api/ai"| API_AI
    NGINX -->|"Proxy /api/market"| API_MARKET

    API_AI -->|"chat(prompt, sessionId, mode)"| AGENT
    AGENT --> PROFILE
    AGENT --> MEMORY
    AGENT --> TOOLS

    TOOLS --> MSYS
    TOOLS --> OTHER

    AGENT -->|"Embeddings / Search"| VDB
    VDB --> DOCS

    AGENT -->|"if OPENAI_API_KEY"| OPENAI
    AGENT -->|"else"| STUB

    %% ูุฑุงูุจุฉ
    API_AI --> LOGS
    API_MARKET --> LOGS
    API_AI --> METRICS
    AGENT --> METRICS

    %% CI/CD
    GIT --> CI --> CD --> NGINX
    CD --> API_AI
    CD --> AGENT

    %% ุงููุณุชูุจู
    AGENT --> SSE
    TOOLS --> MCP
```

---

## ุฎุทูุงุช ุงูุจูุงุก ูู ุงูุตูุฑ ุญุชู ุงูุชุดุบูู

### 1) ุชุซุจูุช ุงูุงุนุชูุงุฏุงุช

```powershell
npm install
```

### 2) ุฅุนุฏุงุฏ ุงูุจูุฆุฉ (ุงุฎุชูุงุฑู)

ููู `.env` ุฃู ูุชุบูุฑุงุช ุงูุจูุฆุฉ:

```bash
# ุชุดุบูู ุจูุง Mongo (ูุถุน ุฐุงูุฑุฉ)
MARKET_ALLOW_DB_FAIL=1
AI_MODEL=gpt-4.1-mini
AI_PROFILE_PATH=./agent-core/profile.json
AI_MEMORY_DIR=./agent-core/memory

# ูุฒูุฏ OpenAI (ุงุฎุชูุงุฑู)
# OPENAI_API_KEY=sk-...
```

### 3) ุชุดุบูู ูุญูู (ุฐุงูุฑุฉ) ุนูู 5500

```powershell
npm run dev:5500
# ุซู ุงูุชุญ:
# http://localhost:5500/pages/ai-chat-healthz.html
# http://localhost:5500/pages/ai-chat.html
```

### 4) ุชุดุบูู ูุน Mongo Atlas ุจุฃูุงู

```powershell
$env:MARKET_MONGO_URL = "mongodb+srv://<user>:<pass>@<cluster>/?retryWrites=true&w=majority"
npm run dev:5500
```
> ูุง ุชุถุน ุจูุงูุงุช ุงูุฏุฎูู ุฏุงุฎู ุงููุณุชูุฏุน. ุงุณุชุฎุฏู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุฃู ุฃุณุฑุงุฑ CI/CD.

### 5) ุงุฎุชุจุงุฑ SSE ุชููุงุฆููุง (ุงุฎุชูุงุฑู)

```powershell
npm run ci:sse
```

---

## ุทุจูุฉ ุงูุฃุฏูุงุช (Tools โ Market Integration)

ุทุจูุฉ ุฃุฏูุงุช ูุงุจูุฉ ููุชูุณุนุฉ (MCP-ready) ุชููููู ุงููููู ูู ุฃุฏุงุก ููุงู ูุงูุนูุฉ ุนุจุฑ ูุงุฌูุงุช ุฃูุธูุฉ ุงูุณูู:

ุฃูุซูุฉ ุนูู ุงูุฃุฏูุงุช ุงูููุชุฑุญุฉ:
- ุงูุจุญุซ ุนู ููุชุฌุงุชุ ูุฑุงุกุฉ ุจูุงูุงุช ุจุงุฆุนุ ุชุญููู ุฃุณุนุงุฑุ ุฅูุดุงุก ุทูุจุงุช.
- ุฃุฏูุงุช ุงููููุงุช ููุฑุงุกุฉ ูุณุชูุฏุงุช ุงููุดุงุฑูุน.

ูุจุฏุฃ ุงูุนูู:
- ูู ุฃุฏุงุฉ Adapter ูุณุชูู (Input โ Validate โ Call System โ Normalize Output).
- ุงูุฃุฏูุงุช ุชูุณุชุฏุนู ูู `agent-core/tools` ุจุญุณุจ ุงูุงุณู ูุงููุนุงููุงุช.

---

## ุงููุฑุงูุจุฉ ูSSE ูุงููุดุฑ

- ุงูููุงููุณ (Prometheus): ุนุฏุฏ ุงูุทูุจุงุชุ ุงูุฃุฎุทุงุกุ ุฒูู ุงูุงุณุชุฌุงุจุฉุ ุงุณุชุฎุฏุงู Tokens.
- ุงูุชุฑููุณุงุช ุงูุฏุงุนูุฉ ููุจุซ ุนุจุฑ ุจุฑููุณู:
  - `Cache-Control: no-cache, no-transform`
  - `X-Accel-Buffering: no`
- ูุดุฑ ุฎูู Nginx/Ingress:
  - ุฑุงุฌุน `infra/nginx/example.conf` ู`infra/k8s/ingress.yaml` ูู ุงููุณุชูุฏุน.
- ุงูุตูุญุงุช ุงูุซุงุจุชุฉ (`/pages`) ุชููุฏูู ูู ููุณ ุงูุฎุงุฏู ูุชูุญูุฏ ุงูุฃุตู ูููุน CORS.

---

## ููุฎุต ููุงุฆู

- ูููู ุฐูุงุก ูุญููู/ูุณุชููุ ูุงุจู ููุชุดุบูู ูู ูุชุตูุญ/ุณูุฑูุฑ/CLIุ ุจูููุฉ ูุณูุงุณุงุช ูุงุถุญุฉ.
- ููุงุฉ ุฐูุงุก (agent-core) ุชูุตู ุงูููุทู ุนู ุงููุงุฌูุฉ ูุงููุฒููุฏุ ูุชูุณููู ุชุจุฏูู ุงูุฃุฏูุงุช ูุงูุฐุงูุฑุฉ.
- ุจุซ SSEุ ุตูุญุงุช ุตุญูุฉุ ููููููุงุช ูุฑุงูุจุฉ ุฌุงูุฒุฉ ููุฅูุชุงุฌ.
- ูุดุฑ ูุจุณูุท ุนุจุฑ ุฎุงุฏู ูุงุญุฏ ุฃู ุฎูู Nginx/Ingress ูุน ุฅุนุฏุงุฏุงุช SSE ุขููุฉ.

> ุงูุงูุชุฑุงุญุงุช ุงููุณุชูุจููุฉ: ุฅุถุงูุฉ ุทุจูุฉ RAG ูุชุฌููุฉ (pgvector/Supabase)ุ ุจุงููุฏ ุฐุงูุฑุฉ SQLiteุ ูุชูุณุนุฉ ุฃุฏูุงุช ุงูุณูู ููู ุงุญุชูุงุฌุงุช ุงูุนูู.

***

ุชู ุฅุนุฏุงุฏ ูุฐุง ุงูุฏููู ููููู ูุฑุฌุนูุง ูุงุญุฏูุง ูุชูุงููุงู ูููู ุงุณุชุฎุฏุงูู ุฏุงุฎู ุงููุณุชูุฏุน ูู `docs/AI_ARCHITECTURE_GUIDE.md`ุ ููููู ูุงุญููุง ุชูููุฏ ูุณุฎุฉ PDF ููุณุฎุฉ ุฅูุฌููุฒูุฉ ููู ุจุณูููุฉ.