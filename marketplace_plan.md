# خطة تنفيذ احترافية لنظام السوق الكبير (Marketplace)

## الهدف العام
- إطلاق نسخة MVP قابلة للإنتاج تدعم: تصفح المنتجات، البحث والتصفية، سلة الشراء، إتمام الطلب، بوابة البائعين، ومراقبة شاملة.
- معايير: أمان، أداء، قابلية توسعة، تجربة مستخدم ممتازة، وتتبّع تشغيل عبر المراقبة والتنبيهات.

## نطاق النسخة الأولى (MVP)
- حسابات وأدوار: مشتري، بائع، مشرف.
- الكتالوج والبحث: منتجات، تصنيفات، فرز، تصفية، صفحات، اقتراحات.
- السلة والطلب: إضافة/إزالة، دمج سلة الزائر، إتمام الطلب، حالة الطلب.
- بوابة البائع: طلب ترقية، إدارة منتجات أساسية.
- المراقبة: Prometheus + Grafana + Alertmanager + SLOs.
- الواجهة: تخطيط مستوحى من المتاجر الكبيرة (هيدر بحث، شريط جانبي للفلاتر، شبكة منتجات متجاوبة).

## خارطة التنفيذ (مراحل)

### المرحلة 1 — الحسابات والهوية (Auth & Accounts)
- ملفات: `auth/` (`routes/auth.js`, `controllers/authController.js`, `models/User.js`, `public/login.html`).
- مهام:
	- إكمال تسجيل/تسجيل الدخول، إعادة تعيين كلمة المرور.
	- توحيد الأدوار وتطبيق صلاحيات: مشتري/بائع/مشرف على مسارات السوق.
	- تكامل واجهات السوق مع حالة المستخدم (زر الحساب/تسجيل الخروج، حماية الصفحات الحساسة).
- معايير القبول:
	- مستخدم يستطيع التسجيل/الدخول والخروج.
	- صفحات البائع والمشرف محمية وتظهر فقط لمن يملك الدور الصحيح.

### المرحلة 2 — الكتالوج والبحث (Catalog & Search)
- ملفات: `models/marketplace/*`, `services/market/productService.js`, `js/market-products.js`, `js/market-search-autocomplete.js`.
- مهام:
	- دعم فلاتر API: `category`, `price_min`, `price_max`, `rating_min` في `/market/products`.
	- تحسين الاستعلامات والفهارس (Mongo): `sku`, `vendor`, `category`, نصّ البحث.
	- وسائط المنتج: صور متعددة، تحسين العرض في البطاقة.
- معايير القبول:
	- البحث والفرز والتصفية تعمل وتنعكس على النتائج والصفحات.
	- زمن استجابة معقول مع بيانات عينة (≤ 300ms p95 في التطوير).

### المرحلة 3 — السلة والدفع (Cart & Checkout)
- ملفات: `services/market/cartService.js`, `js/market-cart.js`, `services/market/payments.js`.
- مهام:
	- دمج سلة الزائر عند التسجيل/الدخول.
	- حساب الشحن والضرائب (stub) وإجمالي الطلب.
	- صفحة إتمام الطلب (Checkout) مع مراجعة العناصر.
- معايير القبول:
	- تدفق كامل من إضافة للسلة → مراجعة → إتمام الطلب.
	- حالات الأخطاء تُعرض للمستخدم بشكل واضح.

### المرحلة 4 — الطلبات والتنفيذ (Orders & Fulfillment)
- ملفات: `models/marketplace/Order.js`, `services/market/orderService.js`, صفحات `pages/my-orders.html`, `order-details.html`.
- مهام:
	- حالات الطلب: جديد → معالجة → مشحون → مُسلّم؛ إرجاع/إلغاء.
	- إشعارات للبائع/المشتري (Email/Webhook بسيط).
- معايير القبول:
	- تحديث الحالة يظهر في الواجهة ويُسجل في النظام.

### المرحلة 5 — بوابة البائع (Seller Portal)
- ملفات: صفحات `seller-*`, `js/sellerProducts.js`, `services/market/vendorService.js`, نموذج `CredibilityScore.js`.
- مهام:
	- مسار ترقية البائع وموافقات المشرف.
	- إدارة المنتجات الأساسية (إضافة/تعديل/حذف)، إدارة المخزون.
	- حساب موثوقية البائع بشكل أولي.
- معايير القبول:
	- بائع يستطيع إدارة منتجاته بعد الموافقة.

### المرحلة 6 — لوحة المشرف (Admin Console)
- ملفات: `pages/admin-*`.
- مهام:
	- موافقات البائعين والمنتجات.
	- تقارير تشغيلية أساسية (قائمة طلبات، منتجات تنتظر مراجعة).
- معايير القبول:
	- مشرف يستطيع الموافقة/الرفض وإدارة المحتوى.

### المرحلة 7 — الواجهة وتجربة المستخدم (UI/UX)
- ملفات: `pages/marketplace-index.html`, `ui-system/components.css`, `css/marketplace.css`.
- مهام:
	- هيدر بحث مع اختيار فئة، شريط جانبي للفلاتر، بانر، شريط تصنيفات، شبكة منتجات.
	- تحسين إمكانية الوصول: RTL، تباين، تركيز، aria labels.
- معايير القبول:
	- الواجهة متجاوبة وتعمل بسلاسة على الهاتف والكمبيوتر.

### المرحلة 8 — الأداء والتخزين المؤقت (Performance & Caching)
- ملفات: `src/cache/`, `src/utils/`, فهارس Mongo.
- مهام:
	- كاش نتائج البحث الشائعة، وكاش طبقة الخدمات.
	- ضبط فهارس قاعدة البيانات، تحسين التجميعات.
	- وسائط: تصغير الصور، lazy-loading، إرشادات CDN.
- معايير القبول:
	- خفض زمن p95 للاستعلامات الثقيلة، وتقليل حمل القاعدة.

### المرحلة 9 — الأمان والامتثال (Security & Compliance)
- ملفات: `utils/validation.js`, `middleware/auth.js`.
- مهام:
	- Rate limiting، تدقيق صلاحيات شامل، سجلات تدقيق.
	- سياسات الاحتفاظ وحذف بيانات المستخدم.
- معايير القبول:
	- حماية المسارات من الإساءة، وإجراءات أساسية للامتثال.

### المرحلة 10 — النشر والمراقبة (Deployment & Observability)
- ملفات: `infra/monitoring/*`, ملفات `.env`، Compose للتطبيق.
- مهام:
	- Docker Compose شامل للخدمات التطبيقية.
	- إدارة أسرار (secrets) وإعدادات البيئات.
	- ترقية Staging → Production، مسار rollback.
- معايير القبول:
	- تشغيل مستقر في Staging ثم إطلاق تدريجي للإنتاج مع مراقبة.

## الجدول المقترح (أسبوعان)
- أيام 1-2: Auth/صلاحيات + أساس الكتالوج/البحث.
- أيام 3-4: السلة/الطلب (MVP) + صفحات الطلبات.
- أيام 5-6: بوابة البائع + موافقات المشرف + تحسين UI.
- أيام 7-8: الأداء/فهارس + كاش الخدمات + وسائط.
- أيام 9-10: الأمان + إعدادات النشر/الأسرار.
- يوم 11: اختبارات شاملة في Staging.
- يوم 12: إطلاق تدريجي ومراقبة.

## تقرير الحالة الحالي (حسب الكود)
- Auth & Accounts: منجز جزئيًا؛ يلزم إحكام الأذونات وتكامل واجهات السوق.
- Catalog & Search: الأساس منجز؛ يلزم دعم فلاتر API وتحسين الفهارس والوسائط.
- Cart & Checkout: منجز جزئيًا؛ يلزم دمج سلة الزائر وصفحة Checkout وحساب الشحن/الضرائب.
- Orders & Fulfillment: الأساس موجود؛ يلزم سير حالات الطلب والإشعارات وتكامل الواجهات.
- Seller Portal: أساس الصفحات والخدمات موجود؛ يلزم تمكين الترقيات والإدارة الفعلية للمخزون والوسائط.
- Admin Console: صفحات موجودة؛ يلزم ربط فعلي بالموافقات والتقارير.
- UI/UX: تقدّم كبير بالتصميم والفلترة والهيكل؛ يلزم تحسين عرض الوسائط وسلايدر عروض.
- Observability & SLOs: مكتمل مع Prometheus/Grafana/Alertmanager وسلو.
- Performance & Caching: بحاجة تنفيذ فهارس وكاش طبقة الخدمات.
- Security & Compliance: بحاجة تعزيز (rate limiting، تدقيق شامل، سجلات).
- Deployment: بحاجة Compose شامل للتطبيق، تنظيم `.env`، أسرار الإنتاج.

## نقاط العمل ذات الأولوية العالية (للإطلاق)
1) دعم فلاتر API في `/market/products` (category/price/rating).
2) Checkout مكتمل + دمج سلة الزائر + إجمالي الطلب.
3) سير حالات الطلب + إشعارات.
4) إحكام صلاحيات Buyer/Seller/Admin عبر جميع المسارات.

## المخاطر والتخفيف
- أداء البحث: حل بفهرسة مناسبة وكاش.
- أمن البيانات: تدقيق صلاحيات شامل وrate limiting.
- إطلاق سريع: اعتماد إطلاق تدريجي مع مراقبة وحالات rollback جاهزة.

---
تم إعداد هذه الخطة لتكون قابلة للتنفيذ مباشرة، مع معايير قبول لكل مرحلة وتجميع مهام واضحة. يمكن ترجمتها إلى تذاكر عمل (Jira/TODO) لكل بند خلال ساعة عمل.
