# دليل الموقع: البنية المعمارية وطرق الاستخدام (الإصدار 2025-11-25)

هذا الدليل يشرح الهيكلية المعمارية للموقع، تدفق البيانات، وآليات الإدارة والتخصيص، مع إرشادات عملية لإضافة المحتوى (المشاريع والشهادات) وضبط السمات العامة. موجّه لمالك الموقع أو من يقوم بالصيانة.

---
## 1. نظرة عامة
- الموقع ثابت (Static) يعتمد على HTML/CSS/JavaScript بدون خادم خلفي.
- يتم تحميل المحتوى ديناميكياً من ملف JSON واحد: `content.json` في الجذر.
- لوحة تحكم (admin.html) تتيح تعديل البيانات وإنشاء ملف JSON جديد للاستبدال.
- واجهتان أساسيتان:
  1. الصفحة الرئيسية `index.html` (عرض السيرة والمشاريع والشهادات).
  2. لوحة الإدارة `admin.html` (إدارة البيانات).
- يدعم لغتين (العربية / الإنجليزية) عبر تبديل السمات وعرض النصوص حسب مفاتيح البيانات.

---
## 2. البنية المعمارية (Architecture)
```
Portofile/
  index.html              <-- الصفحة الرئيسية
  admin.html              <-- لوحة التحكم (دخول بكلمة سر بسيطة)
  content.json            <-- نسخة قديمة/تجريبية (ليست المعتمدة)
  assets/
    css/style.css         <-- التنسيقات + أقسام المشروع والمعرض
    js/script.js          <-- منطق الواجهة الأمامية (تحميل CMS، Marquee، معرض، تنقل، لغة)
    js/admin.js           <-- منطق لوحة التحكم (تحميل/تعديل/توليد JSON)
    data/content.json     <-- ملف المحتوى الفعلي المعتمد عند التشغيل
    images/               <-- صور ثابتة محلية (الشخصية، الشهادات الداخلية)
  PROJECTS_GUIDE.md       <-- دليل مختصر سابق للمشاريع
  CERTIFICATES_GUIDE.md   <-- دليل مختصر للشهادات
  QUICKSTART.md           <-- تعليمات تشغيل سريعة
  README.md               <-- معلومات عامة
  SITE_ARCHITECTURE_AND_USAGE_GUIDE_AR.md <-- (هذا الملف)
```

### طبقات المنظومة
1. طبقة العرض (Presentation): العناصر في `index.html` مزودة بسمات `data-*` لتسهيل تبديل اللغة وحقن المحتوى.
2. طبقة البيانات (Data Layer): ملف `content.json` يضم كائنات `video`, `hero`, `sections`, `certificates`, `projects`.
3. طبقة المنطق (Logic Layer):
   - `script.js`: تشغيل وظائف تهيئة، تحميل البيانات، توليد البطاقات المكررة للـ Marquee، تفعيل المعرض.
   - `admin.js`: إدارة النموذج، قراءة/كتابة JSON، جلسة دخول، تحذير عند فقد التعديلات.
4. طبقة الأنماط (Styles): `style.css` يحوي ثيم، متغيرات ألوان، تصميم البطاقات، عرض marquee، واستجابة الشاشات.

---
## 3. تدفق البيانات (Data Flow)
1. عند تحميل الصفحة الرئيسية يتم تنفيذ `loadCMS()` داخل `script.js`.
2. يتم جلب `content.json` (بدون cache) وتحويله إلى كائن `window.CMS_CONTENT`.
3. يتم استدعاء `applyCMS(lang, data)` لضخ النصوص في العناصر التي تملك `data-cms-key`.
4. بعد نجاح التحميل تُستدعى `initProjects()` و `applyCertificates()` لتوليد القوائم.
5. يتم مضاعفة (Duplicate) مجموعة البطاقات في المشاريع والشهادات عند تفعيل الـ Marquee لضمان تمرير سلس بلا انقطاع.

رسم مبسّط للتدفق:
```
[content.json] --> fetch --> window.CMS_CONTENT --> applyCMS --> DOM تحديث
                                         |--> initProjects() --> توليد بطاقات + تكرار
                                         |--> applyCertificates() --> بطاقات + تكرار
```

---
## 4. ملف المحتوى `content.json`
أقسامه الرئيسة:
- `video`: إعداد عرض خلفية فيديو (YouTube أو ملف MP4).
- `hero`: العنوان، العنوان الفرعي، الوصف (دعم HTML في الوصف عبر `data-cms-html`).
- `sections`: عناوين فرعية لأقسام (projects, certificates, competencies, ...).
- `certificates`: مصفوفة شهادات (عنوان، وصف فرعي، سنة، صورة، أيقونة).
- `projects`: مصفوفة مشاريع (id، عناوين بلغتين، وصف، تصنيف، سنة، موقع، صورة مصغرة، معرض صور).

مثال مشروع مفصل:
```json
{
  "id": "project-1",
  "title": {"ar": "مشروع تجاري كبير", "en": "Major Commercial Project"},
  "description": {"ar": "إدارة تنفيذ مشروع تجاري بميزانية 5 مليون دولار", "en": "Managing execution..."},
  "category": {"ar": "تجاري", "en": "Commercial"},
  "year": "2023",
  "location": {"ar": "دمشق", "en": "Damascus"},
  "thumbnail": "https://.../image.jpg",
  "gallery": ["https://.../img1.jpg", "https://.../img2.jpg"]
}
```

---
## 5. إدارة المحتوى عبر لوحة التحكم (admin.html)
### الدخول
- تتطلب كلمة السر المخزنة داخل `admin.js` في الثابت `ADMIN_PASSWORD` (ينبغي تغييرها قبل النشر).
- بعد الدخول تُنشأ جلسة في `localStorage` مدتها 15 دقيقة وتجدد عند النشاط.

### الواجهة
- أزرار أعلى الصفحة: تحميل المحتوى الحالي، حفظ كملف، حفظ عبر File System API (إن دعم المتصفح)، إضافة شهادة، إضافة مشروع، طي/فتح نماذج المشاريع.
- منطقة تحرير الفيديو، البطل (Hero)، الأقسام، ثم قوائم الشهادات والمشاريع.

### تحرير وحفظ
1. اضغط "تحميل المحتوى" لجلب البيانات الحالية.
2. عدّل الحقول النصية (العربية/الإنجليزية).
3. أضف شهادات أو مشاريع جديدة عبر الأزرار.
4. بالنسبة للمشاريع: حقل المعرض يقبل عدة روابط كل سطر رابط.
5. عند الانتهاء: اضغط "حفظ كـ JSON" لتحميل ملف `content.json` جديد.
6. استبدل الملف الموجود في `content.json` بهذا الملف الجديد (يدوياً أو رفعه إن كان مستضافاً).

### التنبيه عند عدم الحفظ
- أي تغيير في حقول الإدخال يجعل الحالة "غير محفوظة" ويظهر تحذير.
- عند محاولة مغادرة الصفحة قبل الحفظ يعرض المتصفح تحذيراً افتراضياً.

---
## 6. قسم المشاريع (Projects) وآلية الـ Marquee
- يتم بناء البطاقات ديناميكياً في `initProjects()`.
- عند وجود الصنف `marquee` على العنصر `#projects-grid` يتم مضاعفة مجموعة البطاقات (`cards+cards`).
- وظيفة `setupProjectsMarquee()` تُحرّك الحاوية تدريجياً عبر `requestAnimationFrame` وتعيد الإزاحة للصفر عند تخطي نصف العرض (لأن المحتوى مزدوج).
- السرعة تستجيب لحجم الشاشة (سرعات مختلفة لمختلف أجهزة العرض).
- التوقف عند تحويم المستخدم (Hover) لتسهيل القراءة.

### فتح المعرض (Gallery)
- الضغط على بطاقة مشروع يستدعي `openProjectGallery(project)`.
- المعرض يعرض الشرائح + مصغرات + تنقل (يمين/يسار) + دعم لوحة المفاتيح + الإغلاق بـ Escape.

---
## 7. قسم الشهادات (Certificates)
- مشابه للمشاريع في البناء والتكرار لضمان Marquee مستمر.
- البطاقات تحوي صورة، أيقونة (FontAwesome)، عنوان، وصف فرعي، سنة.
- عند خطأ تحميل الصورة يظهر الأيقون فقط (مع معالجة بسيطة في الـ HTML).

---
## 8. تعدد اللغات (Arabic/English)
- المفتاح في أعلى القائمة: زر تبديل اللغة `#lang-toggle`.
- الآلية:
  - عناصر تحمل سمات `data-ar` و `data-en`.
  - عند التبديل: تعدل السمة `lang` و `dir` على `<html>` وتُحدّث النصوص.
  - محتوى يأتي من الـ CMS: إن كان الحقل كائن (يحوي `ar` و `en`) يتم اختيار المناسب.
- بعض الحقول (مثل العنوان الفرعي للبطل) تعتمد تأثير كتابة تدريجي؛ يعطل عند تفضيل "تقليل الحركة".

---
## 9. خلفية الفيديو (Hero Video)
- إعدادات في `content.json` تحت `video`:
  - `url`: رابط YouTube أو ملف MP4 مباشر.
  - `background`: إن كان true يجعل الفيديو يغطي الخلفية (`position:absolute` وفلتر عتمة).
  - `autoplay`, `muted`, `loop` خيارات التشغيل.
- إن كان الرابط يوتيوب: استخراج الـ Video ID وإنشاء iframe إعداد تشغيل صامت متكرر.
- زر التحكم: إيقاف أو تشغيل الخلفية (يغيّر النص والحالة).

---
## 10. المعرض (Project Modal Gallery)
- يعتمد على توليد شرائح + مصغرات.
- التنقل:
  - أزرار يمين/يسار.
  - أسهم لوحة المفاتيح مع مراعاة اتجاه الصفحة (RTL/LTR).
  - يتم تعطيل التمرير `overflow` للجسم أثناء فتح المعرض.
  - الإغلاق: زر، الضغط على الخلفية، مفتاح Escape.

---
## 11. الأداء (Performance) والتحسينات
- استخدام `requestAnimationFrame` للتمرير بدل CSS keyframes لتفادي إعادة تهيئة متكررة وتسهيل التحكم.
- مضاعفة العناصر للقضاء على فجوة نهاية/بداية.
- صور المشاريع والشهادات تستخدم روابط خارجية (Unsplash) لتحسين زمن التحميل مع `loading="lazy"`.
- تقليل حركة عند تفعيل تفضيل المتصفح `prefers-reduced-motion`.
- استخدام `will-change: transform` في عناصر الـ marquee لتسريع GPU compositing.

### تحسينات مستقبلية مقترحة
- سحب وإفلات (Drag & Drop) لإعادة ترتيب المشاريع/الشهادات في لوحة التحكم.
- معاينة فورية للصور قبل الحفظ.
- التحقق من تفرد `id` للمشاريع (منع التكرار).
- تحكم بسرعة الـ Marquee من لوحة الإدارة.
- إضافة بحث/تصفية للمشاريع داخل لوحة التحكم عند زيادة العدد.

---
## 12. الأمان (Security) وحدود الحل الحالي
- كلمة السر مكشوفة في `admin.js` (ليس آمناً للإنتاج العام).
- لا يوجد تشفير للشبكة أو مصادقة حقيقية؛ يُنصح بوضع حماية خادم (Basic Auth) أو نشر اللوحة خلف VPN.
- تجنب وضع معلومات حساسة في `content.json`.

---
## 13. إضافة شهادة جديدة (خطوات عملية)
1. افتح `admin.html` وأدخل كلمة السر.
2. اضغط "إضافة شهادة".
3. عبئ الحقول: العنوان العربي/الإنجليزي، الوصف الفرعي، السنة، رابط الصورة، اسم الأيقونة.
4. اضغط "حفظ كـ JSON".
5. استبدل الملف في `content.json` بالملف الجديد.
6. أعد تحميل الصفحة الرئيسية للتأكد.

مثال أيقونات شائعة: `graduation-cap`, `server`, `medal`, `chart-line`.

---
## 14. إضافة مشروع جديد (خطوات عملية)
1. افتح لوحة التحكم.
2. اضغط "إضافة مشروع".
3. أدخل معرف فريد (مثل `project-4`).
4. العنوان والوصف بلغتين، التصنيف، الموقع، السنة.
5. الصورة المصغرة (يفضل مقاس 800x600 تقريباً أو نسبة 4:3 / 16:10).
6. المعرض: أضف كل رابط في سطر مستقل.
7. احفظ الملف واستبدله في مجلد البيانات ثم اختبر فتح المعرض.

نصيحة: استخدم مصادر صور خارجية (Unsplash / CDN خاص) لتحسين السرعة.

---
## 15. تخصيص الألوان والتصميم
- المتغيرات الرئيسية في `:root` داخل `style.css` (مثل `--accent-blue`, `--card-bg`).
- لتغيير هوية الألوان عدّل هذه القيم فقط لتأثير شامل.
- البطاقات تستخدم تدرجات وخطوط ظل؛ حافظ على التباين لضمان القراءة.

---
## 16. استكشاف الأخطاء الشائعة (Troubleshooting)
| الحالة | السبب المحتمل | الحل |
|--------|---------------|------|
| عدم ظهور مشروع جديد | لم يتم استبدال ملف `content.json` داخل `assets/data/` | تأكد من المسار الصحيح بعد تنزيل الملف من اللوحة |
| بطاقات المشاريع مكررة أكثر من اللازم | تم إزالة صنف `marquee` ثم بقي التكرار القديم | أعد تحميل الصفحة أو أعد تشغيل `initProjects()` بعد تعديل الصنف |
| عدم عمل زر تبديل اللغة | عنصر الزر غير موجود أو حدث خطأ JS مبكر | افحص `console` وتأكد من وجود `<button id="lang-toggle">` |
| توقف التمرير في الشهادات | تحويم الماوس أو خطأ في قياس العرض | اخرج بالمؤشر أو افحص `track.scrollWidth` عبر أدوات المتصفح |
| الفيديو لا يعمل | رابط YouTube غير صالح أو منع تلقائي | تحقق من الـ ID أو استخدم ملف MP4 مباشر مع `muted` و `autoplay` |
| المعرض فارغ | حقل `gallery` للمشروع فارغ أو روابط خاطئة | أضف روابط صحيحة (بروتوكول https) لكل صورة |
| تحذير خروج بدون حفظ | تغيير حدث دون حفظ | نفّذ حفظ JSON قبل الإغلاق |

---
## 17. تكامل الأدلة السابقة
- `PROJECTS_GUIDE.md`: تفاصيل مبدئية لإضافة مشاريع (مكملة لهذا الدليل).
- `CERTIFICATES_GUIDE.md`: إرشادات الشهادات.
- هذا الدليل أشمل: لا يلغي الملفات السابقة لكن يمكن اعتباره المرجع الرئيس.

---
## 18. صيانة مستقبلية
- عند تحديث هيكل `content.json` أضف حقل جديد في `admin.js` داخل `bindToForm()` و `readForm()`.
- حافظ على التوافق الخلفي: وفر قيمة افتراضية إذا كان الحقل القديم مفقود.
- افحص الأداء عند زيادة عدد المشاريع (ربما اعتماد آلية مجزأة أو Lazy Render لاحقاً).

---
## 19. نصائح نشر (Deployment)
- ضع الملفات خلف استضافة تدعم HTTPS (GitHub Pages / Netlify / Vercel / استضافة خاصة).
- أضف حماية للوحة التحكم (Basic Auth على مستوى الخادم) إن كان الموقع عاماً.
- فعّل ضغط GZIP/ Brotli على الخادم لملفات CSS/JS.
- استخدم سياسة تخزين مؤقت (Cache-Control) مناسبة لملفات الصور والخطوط.

---
## 20. ملخص سريع (Quick Recap)
- مصدر الحقيقة: `content.json` في الجذر.
- التحديث عبر `admin.html` → حفظ → استبدال الملف.
- لغة الواجهة تتغير زر واحد ويعتمد سمات `data-*`.
- المشاريع والشهادات تعمل بـ Marquee عبر تكرار المجموعة.
- المعرض يدعم التنقل ولوحة المفاتيح.
- الفيديو في الخلفية قابل للإيقاف/التشغيل.

---
## 21. إعادة الترتيب بالسحب والإفلات (Drag & Drop Sorting)
تمت إضافة دعم إعادة ترتيب الشهادات والمشاريع داخل لوحة التحكم مباشرة دون الحاجة لتعديل يدوي للترتيب في الملف:

### كيف تعمل
1. كل بطاقة (مشروع أو شهادة) أصبحت قابلة للسحب (تم تزويدها بمقبض صغير يحتوي الرمز ⋮⋮).
2. عند السحب فوق قائمة البطاقات يتحرك موضعها ويعاد إدراجها وفق مكان الإفلات.
3. القراءة النهائية للبيانات (عند الحفظ) تعتمد ترتيب العناصر في الـ DOM، مما يعني أن ترتيب العرض في الموقع سيطابق ترتيبك الجديد بعد حفظ ملف JSON.

### الخطوات العملية
1. افتح `admin.html` وسجل الدخول.
2. في قسم الشهادات أو المشاريع: أمسك منطقة المقبض (⋮⋮) واسحب البطاقة للمكان المطلوب.
3. حررها؛ سيُعاد ترقيم العناوين ("مشروع #" / "شهادة #") تلقائياً لتوضيح التسلسل الجديد.
4. أكمل التعديلات الأخرى إن وجدت ثم اضغط "حفظ كـ JSON".
5. استبدل الملف في `content.json` وأعد تحميل الصفحة الرئيسية.

### ملاحظات
- السحب يعيد ترتيب العناصر فقط؛ لا يغير أي حقل داخلي.
- يجب الحفظ بعد الانتهاء كي يُطبق الترتيب في الموقع.
- إن أضفت بطاقة جديدة بعد إعادة ترتيب يمكنك سحبها أيضاً لأي موضع.
- في حال كثرة البطاقات مستقبلاً يمكن توسيع الميزة (مثلاً: زر نقل لأعلى/أسفل أو بحث).

### تحسينات إضافية (تم تنفيذها الآن)
1. أزرار تحريك لأعلى/لأسفل لكل بطاقة (مشروع/شهادة) لتمكين إعادة الترتيب بدون سحب بالماوس.
2. اختصار لوحة المفاتيح: Alt + ArrowUp / Alt + ArrowDown أثناء التركيز على البطاقة ينقلها.
3. تراجع عن الحذف (Undo): عند حذف عنصر يظهر شريط في الأسفل "تم حذف عنصر. تراجع؟" يمكن الضغط عليه لاستعادة آخر عنصر محذوف في موضعه الأصلي.
4. إعادة ترقيم تلقائي فورية بعد أي عملية نقل أو استعادة.

### كيفية استخدام التراجع عن الحذف
1. احذف بطاقة مشروع أو شهادة.
2. يظهر شريط تراجع أسفل الواجهة.
3. اضغط "تراجع" لاستعادتها (يُغلق الشريط تلقائياً).
4. إذا حذفت بطاقة جديدة قبل التراجع عن السابقة، يحتفظ النظام فقط بآخر حذف.

### قيود حالية
- لا يوجد سجل متعدد (History) - فقط آخر عنصر محذوف.
- التراجع لا يعيد حالة "غير محفوظ" إلى محفوظة؛ ما زال يجب حفظ التغييرات بعد الاستعادة.
- في حال تعديل محتوى البطاقة ثم حذفها ثم تراجع، تعود بالقيم الأخيرة المعدلة (لأنها تُجمع مباشرة قبل الحذف).

### تطوير لاحق مقترح
- دعم إعادة الترتيب عبر لوحة المفاتيح (تحسين الوصول).
- تمييز بصري أقوى أثناء السحب (ظل أو ارتفاع).
- حفظ فوري بدون تنزيل الملف (يتطلب بيئة خادم).
- سجل تراجع متعدد العناصر.
- دمج تحذير عند حذف عنصر بدون حفظ سابق.

---
## 22. الحفظ السريع المحلي والتحذيرات
### الحفظ السريع (مسودة محلية)
زر "حفظ سريع" في شريط الأدوات ينشئ مسودة في المتصفح فقط (localStorage) باسم: `CMS_CONTENT_DRAFT`.
يمكن استرجاعها لاحقاً فور فتح اللوحة عبر شريط يسأل: "هناك مسودة محلية محفوظة. استرجاعها؟".

متى تستخدمه؟
- قبل تنزيل الملف النهائي وأنت ما زلت تعدل وتريد نقطة استعادة سريعة.
- عند انقطاع مؤقت في الاتصال أو رغبة بفصل جلسة دون فقد التعديلات.

ملاحظات:
- المسودة لا تُنشر للمستخدمين؛ يجب تنزيل واستبدال الملف في `content.json`.
- مسودة واحدة فقط محفوظة (يتم الكتابة فوقها بكل حفظ سريع جديد).
- استرجاع المسودة يلغي حالة "غير محفوظ" ويعتبرها مرسخة داخل النموذج.

### التحذير عند حذف متكرر
إذا حذفت 4 عناصر متتالية دون حفظ يظهر تنبيه عائم يحثك على الحفظ لتجنب فقد الترتيب أو البيانات.
- يعاد العدّ إلى الصفر عند تنفيذ حفظ (ملف أو مباشر أو حفظ سريع).
- الهدف منع فقد الكثير من التعديلات في جلسة واحدة.

### الفرق بين أنواع الحفظ
| النوع | أين يُخزن | يتطلب استبدال الملف؟ | مناسب لـ |
|-------|----------|----------------------|-----------|
| حفظ كملف | جهازك (تنزيل) | نعم | تجهيز التحديث للنشر |
| حفظ مباشر (File System API) | نفس الملف المفتوح | لا (إن حفظت على الملف الصحيح) | تحديث سريع إذا دعم المتصفح |
| حفظ سريع | localStorage | نعم بعد التصدير | عمل مسودة بين التعديلات |

### حالات الاستخدام المقترحة
- استخدم "حفظ سريع" كل 5-10 دقائق أثناء جلسة تحرير طويلة.
- بعد الانتهاء من مجموعة تغييرات كبيرة استخدم "حفظ كملف" ثم استبدل الملف في مجلد البيانات.

### قيود
- لا يوجد ختم زمني ظاهر للمسودة (يمكن إضافته مستقبلاً).
- المسودة لا تُزامن بين المتصفحات أو الأجهزة.
- حذف المسودة يتم تلقائياً عند مسح بيانات المتصفح أو يدويًا عبر أدوات المطور.

انتهى. لأي توسعة مستقبلية يُنصح بتوثيق الحقول الجديدة هنا.
