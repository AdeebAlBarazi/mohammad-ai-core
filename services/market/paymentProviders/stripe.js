'use strict';\n// Stripe payment provider abstraction (minimal).\n// Requires env: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET.\n// Provides: init(), createIntent({orderId,userId,amount,currency}), retrieveIntent(id), verifyAndParseWebhook(rawBody, signature).\n\nlet stripe = null;\nfunction init(){\n  if(stripe) return stripe;\n  const key = process.env.STRIPE_SECRET_KEY;\n  if(!key){ throw new Error('STRIPE_SECRET_KEY missing'); }\n  try { stripe = require('stripe')(key, { apiVersion: '2023-10-16' }); } catch(e){ throw new Error('stripe_library_missing'); }\n  return stripe;\n}\n\nasync function createIntent({ orderId, userId, amount, currency='SAR' }){\n  init();\n  // Convert to smallest unit; Stripe expects currency minor units (assume SAR has 100 halalas)\n  const unit = Math.round(Number(amount||0) * 100);\n  const intent = await stripe.paymentIntents.create({\n    amount: unit,\n    currency: currency.toLowerCase(),\n    metadata: { orderId: String(orderId), userId: String(userId) },\n    automatic_payment_methods: { enabled: true },\n    description: `Order ${orderId}`\n  });\n  return { ok:true, intentId: intent.id, clientSecret: intent.client_secret, raw: intent };\n}\n\nasync function retrieveIntent(id){\n  init();\n  try { const r = await stripe.paymentIntents.retrieve(id); return { ok:true, raw: r }; } catch(e){ return { ok:false, error: e.message }; }\n}\n\nfunction verifyAndParseWebhook(rawBody, signature){\n  init();\n  const secret = process.env.STRIPE_WEBHOOK_SECRET;\n  if(!secret) return { ok:false, error:'missing_webhook_secret' };\n  try {\n    const event = stripe.webhooks.constructEvent(rawBody, signature, secret);\n    return { ok:true, event };\n  } catch(e){ return { ok:false, error: e.message }; }\n}\n\nmodule.exports = { createIntent, retrieveIntent, verifyAndParseWebhook };